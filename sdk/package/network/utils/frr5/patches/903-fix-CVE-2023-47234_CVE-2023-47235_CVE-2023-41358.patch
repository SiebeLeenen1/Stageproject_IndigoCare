Index: frr-5.0.2/bgpd/bgp_attr.c
===================================================================
--- frr-5.0.2.orig/bgpd/bgp_attr.c
+++ frr-5.0.2/bgpd/bgp_attr.c
@@ -2230,18 +2230,13 @@ static int bgp_attr_check(struct peer *p
 	uint8_t type = 0;
 
 	/* BGP Graceful-Restart End-of-RIB for IPv4 unicast is signaled as an
-	 * empty UPDATE.  */
-	if (CHECK_FLAG(peer->cap, PEER_CAP_RESTART_RCV) && !attr->flag)
-		return BGP_ATTR_PARSE_PROCEED;
-
-	/* "An UPDATE message that contains the MP_UNREACH_NLRI is not required
-	   to carry any other path attributes.", though if MP_REACH_NLRI or NLRI
-	   are present, it should.  Check for any other attribute being present
-	   instead.
+	 * empty UPDATE. Treat-as-withdraw, otherwise if we just ignore it,
+	 * we will pass it to be processed as a normal UPDATE without mandatory
+	 * attributes, that could lead to harmful behavior.
 	 */
-	if ((!CHECK_FLAG(attr->flag, ATTR_FLAG_BIT(BGP_ATTR_MP_REACH_NLRI)) &&
-	     CHECK_FLAG(attr->flag, ATTR_FLAG_BIT(BGP_ATTR_MP_UNREACH_NLRI))))
-		return BGP_ATTR_PARSE_PROCEED;
+	
+	if (CHECK_FLAG(peer->cap, PEER_CAP_RESTART_RCV) && !attr->flag)
+			return BGP_ATTR_PARSE_WITHDRAW;
 
 	if (!CHECK_FLAG(attr->flag, ATTR_FLAG_BIT(BGP_ATTR_ORIGIN)))
 		type = BGP_ATTR_ORIGIN;
@@ -2261,6 +2256,20 @@ static int bgp_attr_check(struct peer *p
 	    && !CHECK_FLAG(attr->flag, ATTR_FLAG_BIT(BGP_ATTR_LOCAL_PREF)))
 		type = BGP_ATTR_LOCAL_PREF;
 
+	/* "An UPDATE message that contains the MP_UNREACH_NLRI is not required
+	   to carry any other path attributes.", though if MP_REACH_NLRI or NLRI
+	   are present, it should.  Check for any other attribute being present
+	   instead.
+	 */
+	if (!CHECK_FLAG(attr->flag, ATTR_FLAG_BIT(BGP_ATTR_MP_REACH_NLRI)) &&
+	    CHECK_FLAG(attr->flag, ATTR_FLAG_BIT(BGP_ATTR_MP_UNREACH_NLRI)))
+		return type ? BGP_ATTR_PARSE_EOR
+			    : BGP_ATTR_PARSE_PROCEED;
+
+	/* If any of the well-known mandatory attributes are not present
+	 * in an UPDATE message, then "treat-as-withdraw" MUST be used.
+	 */
+
 	if (type) {
 		zlog_warn("%s Missing well-known attribute %s.", peer->host,
 			  lookup_msg(attr_str, type, NULL));
@@ -2620,7 +2629,7 @@ bgp_attr_parse_ret_t bgp_attr_parse(stru
 	 */
 	if (attr->flag & (ATTR_FLAG_BIT(BGP_ATTR_AS_PATH))) {
 		ret = bgp_attr_aspath_check(peer, attr);
-		if (ret != BGP_ATTR_PARSE_PROCEED)
+		if (ret == BGP_ATTR_PARSE_PROCEED)
 			return ret;
 	}
 	/* Finally intern unknown attribute. */
Index: frr-5.0.2/bgpd/bgp_packet.c
===================================================================
--- frr-5.0.2.orig/bgpd/bgp_packet.c
+++ frr-5.0.2/bgpd/bgp_packet.c
@@ -1516,7 +1516,7 @@ static int bgp_update_receive(struct pee
 	/* Network Layer Reachability Information. */
 	update_len = end - stream_pnt(s);
 
-	if (update_len) {
+	if (update_len && attribute_len && attr_parse_ret != BGP_ATTR_PARSE_EOR) {
 		/* Set NLRI portion to structure. */
 		nlris[NLRI_UPDATE].afi = AFI_IP;
 		nlris[NLRI_UPDATE].safi = SAFI_UNICAST;
